name: ğŸš€ CI/CD Demo Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

jobs:
  lint:
    name: ğŸ” Code Linting
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        
      - name: ğŸ“‹ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: ğŸ“¦ Install Dependencies
        run: |
          echo "ğŸ”„ Installing project dependencies..."
          npm install --prefer-offline --no-audit
          echo "âœ… Dependencies installed successfully"
          
      - name: ğŸ” Run Linter
        run: |
          echo "ğŸ” Starting code linting process..."
          npm run lint
          echo "âœ… Linting completed successfully"

  test:
    name: ğŸ§ª Run Tests
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        
      - name: ğŸ“‹ Setup Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: ğŸ“¦ Install Dependencies
        run: |
          echo "ğŸ”„ Installing dependencies..."
          npm install --prefer-offline --no-audit
          echo "âœ… Dependencies installed"
          
      - name: ğŸ§ª Run Test Suite
        run: |
          echo "ğŸ§ª Running comprehensive test suite..."
          npm test
          echo "âœ… All tests passed"

  build:
    name: ğŸ—ï¸ Build Application
    runs-on: ubuntu-latest
    needs: [lint, test]
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        
      - name: ğŸ“‹ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: ğŸ“¦ Install Dependencies
        run: |
          echo "ğŸ”„ Installing build dependencies..."
          npm install --prefer-offline --no-audit
          echo "âœ… Build dependencies ready"
          
      - name: ğŸ—ï¸ Build Project
        run: |
          echo "ğŸ—ï¸ Starting application build process..."
          echo "ğŸ“Š Build stats:"
          echo "  - Build ID: ${{ github.run_id }}"
          echo "  - Commit: ${{ github.sha }}"
          echo "  - Branch: ${{ github.ref_name }}"
          npm run build
          echo "âœ… Build completed successfully"
          
      - name: ğŸ“Š Build Summary
        run: |
          echo "ğŸ“Š Build Summary Report"
          echo "======================="
          echo "âœ… Status: SUCCESS"
          echo "ğŸ•’ Build Duration: ~5 seconds"
          echo "ğŸ“ Commit: ${{ github.sha }}"
          echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
          echo "ğŸ‘¤ Author: ${{ github.actor }}"

  security-scan:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        
      - name: ğŸ“‹ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: ğŸ”’ Run Security Audit
        run: |
          echo "ğŸ”’ Starting security vulnerability scan..."
          echo "ğŸ“‹ Checking for known vulnerabilities..."
          npm audit --audit-level moderate || true
          echo "âœ… Security scan completed"
          
      - name: ğŸ“Š Security Report
        run: |
          echo "ğŸ”’ Security Scan Summary"
          echo "======================="
          echo "âœ… Scan completed successfully"
          echo "ğŸ“… Scan Date: $(date)"
          echo "ğŸ” Audit Level: Moderate"

  deploy:
    name: ğŸš€ Deploy to ${{ github.event.inputs.environment || 'staging' }}
    runs-on: ubuntu-latest
    needs: [build, security-scan]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || github.event_name == 'workflow_dispatch'
    environment: 
      name: ${{ github.event.inputs.environment || 'staging' }}
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        
      - name: ğŸš€ Deploy Application
        run: |
          echo "ğŸš€ Starting deployment to ${{ github.event.inputs.environment || 'staging' }}..."
          echo "ğŸ¯ Target Environment: ${{ github.event.inputs.environment || 'staging' }}"
          echo "ğŸ“¦ Deploying commit: ${{ github.sha }}"
          echo "ğŸ·ï¸ Version: ${{ github.run_number }}"
          npm run deploy
          echo "âœ… Deployment completed successfully"
          
      - name: ğŸ‰ Deployment Success
        run: |
          echo "ğŸ‰ Deployment Summary"
          echo "===================="
          echo "âœ… Status: SUCCESS"
          echo "ğŸŒ Environment: ${{ github.event.inputs.environment || 'staging' }}"
          echo "ğŸ“¦ Version: v1.0.${{ github.run_number }}"
          echo "ğŸ•’ Deployed at: $(date)"
          echo "ğŸ”— Commit: https://github.com/${{ github.repository }}/commit/${{ github.sha }}"
          echo "ğŸ‘¤ Deployed by: ${{ github.actor }}"
          echo ""
          echo "ğŸš€ Deployment pipeline completed successfully!"