name: ðŸš€ Deploy to GCP Cloud Run

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
  push:
    branches: [ master ]
    paths-ignore:
      - 'README.md'
      - '*.md'

env:
  PROJECT_ID: ci-cd-demo-466714
  REGION: us-central1
  BACKEND_SERVICE: ci-cd-backend
  FRONTEND_SERVICE: ci-cd-frontend

jobs:
  deploy-backend:
    name: ðŸ”§ Deploy Backend to Cloud Run
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ” Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: ðŸ› ï¸ Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: ðŸ”§ Configure Docker to use Artifact Registry
        run: gcloud auth configure-docker us-central1-docker.pkg.dev

      - name: ðŸ—ï¸ Build Backend Docker Image
        run: |
          echo "ðŸ—ï¸ Building backend container image..."
          docker build -f backend/Dockerfile -t us-central1-docker.pkg.dev/$PROJECT_ID/cloud-run-source-deploy/$BACKEND_SERVICE:$GITHUB_SHA -t us-central1-docker.pkg.dev/$PROJECT_ID/cloud-run-source-deploy/$BACKEND_SERVICE:latest .
          echo "âœ… Backend image built successfully"

      - name: ðŸ“¤ Push Backend Image to Container Registry
        run: |
          echo "ðŸ“¤ Pushing backend image to Artifact Registry..."
          docker push us-central1-docker.pkg.dev/$PROJECT_ID/cloud-run-source-deploy/$BACKEND_SERVICE:$GITHUB_SHA
          docker push us-central1-docker.pkg.dev/$PROJECT_ID/cloud-run-source-deploy/$BACKEND_SERVICE:latest
          echo "âœ… Backend image pushed successfully"

      - name: ðŸš€ Deploy Backend to Cloud Run
        run: |
          echo "ðŸš€ Deploying backend to Cloud Run..."
          gcloud run deploy $BACKEND_SERVICE \
            --image us-central1-docker.pkg.dev/$PROJECT_ID/cloud-run-source-deploy/$BACKEND_SERVICE:$GITHUB_SHA \
            --platform managed \
            --region $REGION \
            --port 8080 \
            --allow-unauthenticated \
            --set-env-vars="NODE_ENV=production,GITHUB_APP_ID=${{ secrets.APP_ID }},GITHUB_APP_INSTALLATION_ID=${{ secrets.APP_INSTALLATION }},GITHUB_REPO_OWNER=${{ secrets.REPO_OWNER }},GITHUB_REPO_NAME=${{ secrets.REPO_NAME }},GITHUB_APP_PRIVATE_KEY=${{ secrets.APP_PRIVATE_KEY }}" \
            --memory 1Gi \
            --cpu 1 \
            --max-instances 10
          echo "âœ… Backend deployed successfully"

      - name: ðŸ“‹ Get Backend Service URL
        id: backend-url
        run: |
          BACKEND_URL=$(gcloud run services describe $BACKEND_SERVICE --platform managed --region $REGION --format 'value(status.url)')
          echo "backend_url=$BACKEND_URL" >> $GITHUB_OUTPUT
          echo "ðŸ”— Backend URL: $BACKEND_URL"

    outputs:
      backend_url: ${{ steps.backend-url.outputs.backend_url }}

  deploy-frontend:
    name: ðŸŽ¨ Deploy Frontend to Cloud Run
    runs-on: ubuntu-latest
    needs: deploy-backend
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ” Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: ðŸ› ï¸ Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: ðŸ”§ Configure Docker to use Artifact Registry
        run: gcloud auth configure-docker us-central1-docker.pkg.dev

      - name: ðŸ—ï¸ Build Frontend Docker Image
        env:
          BACKEND_URL: ${{ needs.deploy-backend.outputs.backend_url }}
        run: |
          echo "ðŸ—ï¸ Building frontend container image..."
          echo "ðŸ”— Using backend URL: $BACKEND_URL"
          docker build -f frontend/Dockerfile -t us-central1-docker.pkg.dev/$PROJECT_ID/cloud-run-source-deploy/$FRONTEND_SERVICE:$GITHUB_SHA -t us-central1-docker.pkg.dev/$PROJECT_ID/cloud-run-source-deploy/$FRONTEND_SERVICE:latest .
          echo "âœ… Frontend image built successfully"

      - name: ðŸ“¤ Push Frontend Image to Container Registry
        run: |
          echo "ðŸ“¤ Pushing frontend image to Artifact Registry..."
          docker push us-central1-docker.pkg.dev/$PROJECT_ID/cloud-run-source-deploy/$FRONTEND_SERVICE:$GITHUB_SHA
          docker push us-central1-docker.pkg.dev/$PROJECT_ID/cloud-run-source-deploy/$FRONTEND_SERVICE:latest
          echo "âœ… Frontend image pushed successfully"

      - name: ðŸš€ Deploy Frontend to Cloud Run
        run: |
          echo "ðŸš€ Deploying frontend to Cloud Run..."
          gcloud run deploy $FRONTEND_SERVICE \
            --image us-central1-docker.pkg.dev/$PROJECT_ID/cloud-run-source-deploy/$FRONTEND_SERVICE:$GITHUB_SHA \
            --platform managed \
            --region $REGION \
            --port 80 \
            --allow-unauthenticated \
            --memory 1Gi \
            --cpu 1 \
            --max-instances 10
          echo "âœ… Frontend deployed successfully"

      - name: ðŸ“‹ Get Frontend Service URL
        id: frontend-url
        run: |
          FRONTEND_URL=$(gcloud run services describe $FRONTEND_SERVICE --platform managed --region $REGION --format 'value(status.url)')
          echo "frontend_url=$FRONTEND_URL" >> $GITHUB_OUTPUT
          echo "ðŸ”— Frontend URL: $FRONTEND_URL"

      - name: ðŸŽ‰ Deployment Summary
        run: |
          echo "ðŸŽ‰ Deployment Complete!"
          echo "====================="
          echo "âœ… Backend: ${{ needs.deploy-backend.outputs.backend_url }}"
          echo "âœ… Frontend: ${{ steps.frontend-url.outputs.frontend_url }}"
          echo "ðŸš€ Your CI/CD Playground is now live on GCP Cloud Run!"